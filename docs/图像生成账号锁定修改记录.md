# 图像生成账号锁定功能修改记录

**修改日期**: 2026-01-01  
**修改文件**: `src-tauri/src/proxy/token_manager.rs`  
**修改目的**: 解决图像生成请求导致双重账号扣费的问题

---

## 问题描述

用户发现在使用 ComfyUI 节点通过反向代理生成图像时，连续的请求会轮换使用不同的账号，导致多个账号被扣费。

### 原因分析

在 `token_manager.rs` 的 `get_token` 函数中，`image_gen` 类型的请求被特殊排除在 60 秒锁定机制之外：

```rust
// 原代码 (第 188 行)
if !rotate && quota_group != "image_gen" {
```

这意味着每次图像生成请求都会轮换到下一个账号（round-robin），而不是复用最近使用的账号。

---

## 修改内容

### 修改前

```rust
if !rotate && quota_group != "image_gen" {
    // 在锁内一站式完成：1. 检查锁定 2. 选择新账号 3. 更新锁定
    ...
} else {
    // 画图请求或强制轮换，不使用 session 锁定
    ...
}
```

### 修改后

```rust
// [2026-01-01] 移除 image_gen 的特殊排除，让图像生成请求也使用 60s 锁定
// 原代码: if !rotate && quota_group != "image_gen"
// 回滚方法: 将下行改回 if !rotate && quota_group != "image_gen"
if !rotate {
    // 在锁内一站式完成：1. 检查锁定 2. 选择新账号 3. 更新锁定
    ...
} else {
    // 强制轮换时不使用 session 锁定
    // [2026-01-01] 注: 原代码此处同时包含 image_gen 请求，现已移除该特殊处理
    ...
}
```

---

## 行为变化

| 场景 | 修改前 | 修改后 |
|------|--------|--------|
| 60秒内连续图像请求 | 每次轮换账号 | 复用同一账号 |
| 超过60秒后的图像请求 | 轮换账号 | 轮换账号 |
| 聊天/文本请求 | 60秒锁定 | 60秒锁定 (无变化) |

---

## 回滚方法

如果需要恢复原来的行为（图像生成请求不使用锁定），请执行以下步骤：

1. 打开 `src-tauri/src/proxy/token_manager.rs`
2. 找到第 188 行附近的代码
3. 将 `if !rotate {` 改回 `if !rotate && quota_group != "image_gen" {`
4. 重新编译项目：`.\build.bat`

---

## 编译验证

修改完成后，请运行以下命令验证编译：

```powershell
cd H:\AI\Antigravity-Manager
.\build.bat
```

---

## 测试建议

1. 启动修改后的程序
2. 在 ComfyUI 中连续发起 2-3 次图像生成请求
3. 查看日志确认所有请求使用同一账号：
   ```
   [Images] Using account: xxx@gmail.com for image generation
   ```
4. 等待 60 秒后再次发起请求，确认账号可以正常轮换
