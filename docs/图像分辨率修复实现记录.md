# 图像分辨率修复 - 实现记录

## 概述
已按照 `docs/图像分辨率修复开发文档.md` 修改 v3.3.8 代码，实现 **3 种质量规格** (standard, medium, hd) 到 Gemini API imageSize 参数的映射。

## 修改文件

### [openai.rs](file:///H:/tmp/Antigravity-Manager/src-tauri/src/proxy/handlers/openai.rs)

#### 1. `handle_images_generations` (图像生成端点)

**新增功能：**
- Quality 到 imageSize 映射：
  | quality | imageSize | 分辨率 |
  |---------|-----------|--------|
  | standard | 1K | ~1024px |
  | medium | 2K | ~2048px |
  | hd | 4K | ~4096px |
- 添加 `responseModalities: ["IMAGE"]`
- 添加 `imageConfig.imageSize` 参数

```diff
+    let image_size = match quality {
+        "hd" => "4K",
+        "medium" => "2K",
+        _ => "1K",
+    };

     "generationConfig": {
         "candidateCount": 1,
+        "responseModalities": ["IMAGE"],
         "imageConfig": {
-            "aspectRatio": aspect_ratio
+            "aspectRatio": aspect_ratio,
+            "imageSize": image_size
         }
     }
```

#### 2. `handle_images_edits` (图像编辑端点)

**新增功能：**
- 解析 multipart 中的 `quality` 参数
- Size 到 aspectRatio 映射
- Quality 到 imageSize 映射
- 更新 generationConfig 为图像生成配置

```diff
+    let mut quality = "standard".to_string();

+    } else if name == "quality" {
+        if let Ok(val) = field.text().await {
+            quality = val;
+        }
+    }

+    let aspect_ratio = match size.as_str() { ... };
+    let image_size = match quality.as_str() { ... };

     "generationConfig": {
         "candidateCount": 1,
-        "maxOutputTokens": 8192,
-        "stopSequences": [],
-        "temperature": 1.0,
-        "topP": 0.95,
-        "topK": 40
+        "responseModalities": ["IMAGE"],
+        "imageConfig": {
+            "aspectRatio": aspect_ratio,
+            "imageSize": image_size
+        }
     }
```

---

## 编译脚本

创建了 [build.bat](file:///H:/tmp/Antigravity-Manager/build.bat)：
- 检查 npm 和 cargo 环境
- 安装依赖后执行 `npm run tauri build`
- 输出路径：`src-tauri\target\release\antigravity-tools.exe`

---

## 与 3.3.7 版本对比

| 功能点 | 3.3.8 修改后 | 3.3.7 参考 | 状态 |
|--------|-------------|-----------|------|
| quality→imageSize 映射 | ✅ | ✅ | 一致 |
| 3级质量 (standard/medium/hd) | ✅ | ✅ | 一致 |
| responseModalities | ✅ | ✅ | 一致 |
| imageConfig 结构 | ✅ | ✅ | 一致 |
| edits 端点 quality 解析 | ✅ | ✅ | 一致 |
| edits 端点 aspectRatio 映射 | ✅ | ✅ | 一致 |

**结论：** 所有修改与 3.3.7 参考实现一致 ✅

---

## 编译命令

```batch
cd H:\tmp\Antigravity-Manager
build.bat
```

或手动执行：
```batch
npm install
npm run tauri build
```
