# 多参考图功能开发文档

**日期**: 2026-01-09
**版本**: v3.4.0
**功能**: 支持 Images Edit API 接收多张参考图（最多7张）

## 背景

为配合 ComfyUI-OpenAI-ImageGen 节点的多参考图输入功能，Antigravity-Manager 需要支持解析 `/v1/images/edits` 端点中的多张图片。

本功能允许用户在一次图像编辑请求中提供最多 **7 张参考图**（image + image2 ~ image7），以实现更复杂的多图参考编辑场景。

## 代码变更

### 文件: `src-tauri/src/proxy/handlers/openai.rs`

#### 1. 新增变量声明 (第 968-974 行)

```diff
-    let mut image_data = None;
+    let mut image_data: Option<String> = None;
+    let mut image2_data: Option<String> = None;
+    let mut image3_data: Option<String> = None;
+    let mut image4_data: Option<String> = None;
+    let mut image5_data: Option<String> = None;
+    let mut image6_data: Option<String> = None;
+    let mut image7_data: Option<String> = None;
     let mut mask_data = None;
```

#### 2. 新增字段解析 (第 1025-1065 行)

```rust
} else if name == "image2" {
    let data = field
        .bytes()
        .await
        .map_err(|e| (StatusCode::BAD_REQUEST, format!("Image2 read error: {}", e)))?;
    image2_data = Some(base64::engine::general_purpose::STANDARD.encode(data));
} else if name == "image3" {
    let data = field
        .bytes()
        .await
        .map_err(|e| (StatusCode::BAD_REQUEST, format!("Image3 read error: {}", e)))?;
    image3_data = Some(base64::engine::general_purpose::STANDARD.encode(data));
} else if name == "image4" {
    let data = field
        .bytes()
        .await
        .map_err(|e| (StatusCode::BAD_REQUEST, format!("Image4 read error: {}", e)))?;
    image4_data = Some(base64::engine::general_purpose::STANDARD.encode(data));
} else if name == "image5" {
    let data = field
        .bytes()
        .await
        .map_err(|e| (StatusCode::BAD_REQUEST, format!("Image5 read error: {}", e)))?;
    image5_data = Some(base64::engine::general_purpose::STANDARD.encode(data));
} else if name == "image6" {
    let data = field
        .bytes()
        .await
        .map_err(|e| (StatusCode::BAD_REQUEST, format!("Image6 read error: {}", e)))?;
    image6_data = Some(base64::engine::general_purpose::STANDARD.encode(data));
} else if name == "image7" {
    let data = field
        .bytes()
        .await
        .map_err(|e| (StatusCode::BAD_REQUEST, format!("Image7 read error: {}", e)))?;
    image7_data = Some(base64::engine::general_purpose::STANDARD.encode(data));
}
```

#### 3. 更新日志输出 (第 1075-1084 行)

```rust
tracing::info!(
    "[Images] Edit Request: model={}, prompt={}, n={}, size={}, images={}, mask={}, response_format={}",
    model,
    prompt,
    n,
    size,
    1 + image2_data.is_some() as i32 + image3_data.is_some() as i32
        + image4_data.is_some() as i32 + image5_data.is_some() as i32
        + image6_data.is_some() as i32 + image7_data.is_some() as i32,
    mask_data.is_some(),
    response_format
);
```

#### 4. 添加多图到请求体 (第 1137-1201 行)

```rust
// Add second reference image if provided
if let Some(data) = image2_data {
    contents_parts.push(json!({
        "inlineData": {
            "mimeType": "image/png",
            "data": data
        }
    }));
    tracing::info!("[Images] Added second reference image");
}

// Add third reference image if provided
if let Some(data) = image3_data {
    contents_parts.push(json!({
        "inlineData": {
            "mimeType": "image/png",
            "data": data
        }
    }));
    tracing::info!("[Images] Added third reference image");
}

// Add fourth reference image if provided
if let Some(data) = image4_data {
    contents_parts.push(json!({
        "inlineData": {
            "mimeType": "image/png",
            "data": data
        }
    }));
    tracing::info!("[Images] Added fourth reference image");
}

// Add fifth reference image if provided
if let Some(data) = image5_data {
    contents_parts.push(json!({
        "inlineData": {
            "mimeType": "image/png",
            "data": data
        }
    }));
    tracing::info!("[Images] Added fifth reference image");
}

// Add sixth reference image if provided
if let Some(data) = image6_data {
    contents_parts.push(json!({
        "inlineData": {
            "mimeType": "image/png",
            "data": data
        }
    }));
    tracing::info!("[Images] Added sixth reference image");
}

// Add seventh reference image if provided
if let Some(data) = image7_data {
    contents_parts.push(json!({
        "inlineData": {
            "mimeType": "image/png",
            "data": data
        }
    }));
    tracing::info!("[Images] Added seventh reference image");
}
```

## API 接口变更

### `/v1/images/edits` (POST, multipart/form-data)

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `image` | file | ✅ | 主参考图 (第1张) |
| `image2` | file | ❌ | 第2张参考图 |
| `image3` | file | ❌ | 第3张参考图 |
| `image4` | file | ❌ | 第4张参考图 |
| `image5` | file | ❌ | 第5张参考图 |
| `image6` | file | ❌ | 第6张参考图 |
| `image7` | file | ❌ | 第7张参考图 |
| `prompt` | string | ✅ | 编辑提示词 |
| `size` | string | ❌ | 输出尺寸 |
| `quality` | string | ❌ | 图像质量 |

### 使用示例

```bash
curl -X POST http://127.0.0.1:8045/v1/images/edits \
  -F "image=@reference1.png" \
  -F "image2=@reference2.png" \
  -F "image3=@reference3.png" \
  -F "image4=@reference4.png" \
  -F "prompt=融合这些图片的风格" \
  -F "size=1024x1024" \
  -F "quality=hd"
```

## 技术说明

### Gemini API 内容结构

所有参考图会被添加到 Gemini API 请求的 `contents` 数组中：

```json
{
  "contents": [{
    "role": "user",
    "parts": [
      { "text": "Edit this image: {prompt}" },
      { "inlineData": { "mimeType": "image/png", "data": "{image1_base64}" } },
      { "inlineData": { "mimeType": "image/png", "data": "{image2_base64}" } },
      ...
      { "inlineData": { "mimeType": "image/png", "data": "{image7_base64}" } }
    ]
  }]
}
```

### 图片处理顺序

图片按照 `image` → `image2` → `image3` → ... → `image7` 的顺序添加到请求中。

### 图片数量限制

- **最少**: 1 张（`image` 必填）
- **最多**: 7 张（`image` + `image2` ~ `image7`）
- **中间值**: 可以只提供部分图片（如只提供 image + image2 + image4）

## 回滚说明

如需回滚此功能，移除以下代码：

### 变量声明
- 删除 `image2_data` ~ `image7_data` 变量声明（第 969-974 行）

### 字段解析
- 删除 `"image2"` ~ `"image7"` 字段的解析逻辑（第 1025-1065 行）

### 日志输出
- 更新图片计数为只计算 `image2_data` 和 `image3_data`，或简化为固定值

### 请求体构建
- 删除将 `image2_data` ~ `image7_data` 添加到 `contents_parts` 的代码块（第 1137-1201 行）

## 版本历史

| 日期 | 版本 | 变更 |
|------|------|------|
| 2026-01-01 | v3.4.0 | 初始实现，支持3张参考图 |
| 2026-01-09 | v3.4.0 | 扩展支持至7张参考图 |

## 相关文档

- [图像分辨率修复开发文档](./图像分辨率修复开发文档.md)
- [文档对齐修复 Walkthrough](./walkthrough-文档对齐修复.md)
- [代码修复 Walkthrough](./代码修复walkthrough.md)
