# Antigravity Manager 图像分辨率修复开发文档

## 修改日期
2025-12-30

## 问题描述

### 现象
通过 ComfyUI 节点调用 Antigravity Manager 的图像生成 API 时，即使选择了 `size: 1024x1792` 和 `quality: hd`，返回的图像仍然只有约 848x1248 的分辨率。

### 根本原因
Antigravity Manager 在处理 OpenAI Images API 请求时，只将 `size` 参数映射为 Gemini API 的 `aspectRatio`（宽高比），但没有将 `quality` 参数映射为 `imageSize`（分辨率控制参数）。

Gemini API 的图像分辨率由 `imageConfig.imageSize` 参数控制：
- `"1K"` = ~1024px（默认）
- `"2K"` = ~2048px
- `"4K"` = ~4096px

## 修改内容

### 文件
`src-tauri/src/proxy/handlers/openai.rs`

### 1. 图像生成端点 (`handle_images_generations`)

#### 位置：约第 744-785 行

#### 修改内容

**添加 quality 到 imageSize 的映射：**
```rust
// 4. 映射 quality 到 imageSize (Gemini API 实际控制分辨率的参数)
// "1K" = ~1024px, "2K" = ~2048px, "4K" = ~4096px
let image_size = if quality == "hd" { "4K" } else { "1K" };

tracing::info!(
    "[Images] Mapped quality '{}' to imageSize '{}'",
    quality,
    image_size
);
```

**更新 Gemini API 请求体，添加 `responseModalities` 和 `imageSize`：**
```rust
"generationConfig": {
    "candidateCount": 1,
    "responseModalities": ["IMAGE"],
    "imageConfig": {
        "aspectRatio": aspect_ratio,
        "imageSize": image_size
    }
}
```

---

### 2. 图像编辑端点 (`handle_images_edits`)

#### 位置：约第 908-1080 行

#### 修改内容

**添加 quality 参数解析：**
```rust
let mut quality = "standard".to_string();
// ... 在 multipart 解析循环中添加 ...
} else if name == "quality" {
    if let Ok(val) = field.text().await {
        quality = val;
    }
}
```

**添加 aspectRatio 和 imageSize 映射：**
```rust
// 2. 映射 size 到 aspectRatio
let aspect_ratio = match size.as_str() {
    "1792x1024" | "1920x1080" => "16:9",
    "1024x1792" | "1080x1920" => "9:16",
    "1024x768" | "1280x960" => "4:3",
    "768x1024" | "960x1280" => "3:4",
    _ => "1:1",
};

// 3. 映射 quality 到 imageSize
let image_size = if quality == "hd" { "4K" } else { "1K" };
```

**更新 Gemini API 请求体：**
将原来的文本生成配置替换为图像生成配置：
```rust
"generationConfig": {
    "candidateCount": 1,
    "responseModalities": ["IMAGE"],
    "imageConfig": {
        "aspectRatio": aspect_ratio,
        "imageSize": image_size
    }
}
```

## 测试结果

| 模式 | 参数 | 修改前 | 修改后 |
|------|------|--------|--------|
| 生成模式 | 1024x1792, hd | ~848x1248 | **3072x5504** ✅ |
| 编辑模式 | 1024x1792, hd | ~768x1376 | ~768x1376 |

**注意**：编辑模式的分辨率限制是 Gemini API 本身的行为，当使用参考图时 API 可能会忽略 imageSize 参数。

## 编译说明

```bash
cd h:\AI\Antigravity-Manager
npm run tauri build
```

输出位置：`src-tauri\target\release\antigravity-tools.exe`

## 参考资料

- [Gemini API Image Generation 文档](https://ai.google.dev/gemini-api/docs/image-generation)
- `imageSize` 参数必须使用大写 K（如 `"4K"`，不是 `"4k"`）
